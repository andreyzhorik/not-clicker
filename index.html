<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NotCoins — Dark Clicker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#041021;
    --panel:#071726;
    --muted:#9aa6b5;
    --accent:#7EE0FF;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --accent-2:#7CFFB2;
    --radius:12px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#041021 0%,#071526 100%);color:#d9eef6}
  .wrap{max-width:1100px;margin:28px auto;padding:18px;display:grid;grid-template-columns:1fr 340px;gap:18px;}
  .card{background:linear-gradient(180deg,var(--panel),#051426);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03);}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{font-size:18px;margin:0;color:var(--accent);letter-spacing:0.2px}
  .mini{font-size:13px;color:var(--muted)}
  .status{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .balance{padding:12px;border-radius:10px;background:var(--glass);min-width:160px;text-align:center}
  .balance .num{font-weight:800;font-size:26px;color:var(--accent)}
  .click-row{display:flex;gap:12px;align-items:center}
  #clickBtn{flex:1;padding:22px;border-radius:10px;background:linear-gradient(180deg,#0fb0ff,#0a87b8);border:0;color:#012026;font-weight:800;cursor:pointer;font-size:16px}
  #clickBtn:active{transform:translateY(1px)}
  .side-info{width:180px;display:flex;flex-direction:column;gap:8px}
  .pill{background:var(--glass-2);padding:8px;border-radius:8px;text-align:center;color:var(--muted);font-weight:600}
  .shop{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);text-align:center}
  .item .title{font-weight:700;color:var(--accent-2);margin-bottom:6px}
  .item button{margin-top:6px;padding:6px 8px;border-radius:8px;border:0;background:#0b6b5e;color:#dffcf0;cursor:pointer;font-weight:700}
  .item button[disabled]{opacity:0.38;cursor:not-allowed;background:#123939}
  aside{display:flex;flex-direction:column;gap:12px}
  .leaderboard{max-height:420px;overflow:auto;padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
  .lb-row{display:flex;justify-content:space-between;padding:8px;border-radius:6px}
  .controls{display:flex;gap:8px;align-items:center}
  input[type="text"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  button.simple{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent);cursor:pointer}
  .flash{position:fixed;left:50%;transform:translateX(-50%);top:18px;background:#04202a;padding:8px 12px;border-radius:8px;color:var(--accent-2);display:none;z-index:999}
  .tiny{font-size:12px;color:var(--muted)}
  @media (max-width:960px){
    .wrap{grid-template-columns:1fr;padding:12px}
    .shop{grid-template-columns:repeat(2,1fr)}
    aside{order:-1}
  }
</style>
</head>
<body>
<div class="wrap">
  <main class="card">
    <header>
      <h1>NotCoins</h1>
      <div class="mini">dark • auto 5s</div>
    </header>

    <div class="status">
      <div class="balance">
        <div class="tiny">Balance</div>
        <div id="balance" class="num">0</div>
        <div class="tiny">CPS <span id="cps">0</span> • Click <span id="clickVal">1</span></div>
      </div>

      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="tiny">Player <strong id="playerName">Guest</strong></div>
          <div class="tiny">Clicks <span id="totalClicks">0</span></div>
        </div>

        <div class="click-row">
          <button id="clickBtn">Tap • +<span id="perClick">1</span></button>
          <div class="side-info">
            <div class="pill" id="ownedItems">0 items</div>
            <div class="pill tiny" id="saveStateText">saved: never</div>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="tiny">Shop</div>
      <div class="tiny">Auto-update: On (5s)</div>
    </div>

    <div id="shopList" class="shop" aria-live="polite"></div>
  </main>

  <aside class="card">
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="tiny">Name</div>
      <div class="controls">
        <input id="nameInput" placeholder="set name" />
        <button id="setNameBtn" class="simple">Set</button>
      </div>
    </div>

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="tiny">Leaderboard</div>
        <div style="display:flex;gap:8px">
          <button id="refreshLb" class="simple">Refresh</button>
          <button id="submitBtn" class="simple">Update</button>
        </div>
      </div>
      <div id="leaderboard" class="leaderboard" style="margin-top:8px"></div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="clearLocal" class="simple">Clear</button>
      <div class="tiny">minimal • dark</div>
    </div>
  </aside>
</div>

<div id="flash" class="flash"></div>

<script>
(() => {
  const API = 'https://68eeed86b06cc802829ba196.mockapi.io/leaderboardclicker';
  const STORAGE = 'notcoins_dark_v2';
  const NAME_KEY = 'notcoins_name_v2';
  const LOCK_KEY = 'notcoins_name_lock_v2';
  const LAST_SUB_KEY = 'notcoins_last_sub_v2';
  const REFRESH_MS = 5000; // now 5 seconds

  // expanded shop
  const shop = [
    {id:'cursor', name:'Cursor', price:15, type:'click', val:1},
    {id:'gloves', name:'Gloves', price:60, type:'click', val:5},
    {id:'auto', name:'Auto', price:80, type:'cps', val:0.5},
    {id:'grandma', name:'Grandma', price:140, type:'cps', val:2},
    {id:'drone', name:'Drone', price:600, type:'cps', val:12},
    {id:'miner', name:'Miner', price:700, type:'cps', val:9},
    {id:'solar', name:'Solar Array', price:2200, type:'cps', val:60},
    {id:'factory', name:'Factory', price:3500, type:'cps', val:45},
    {id:'bank', name:'Bank', price:18000, type:'cps', val:250},
    {id:'mult', name:'Booster', price:500, type:'mult', val:1.2},
    {id:'exosuit', name:'Exosuit', price:4200, type:'mult', val:1.5},
    {id:'quantum', name:'Quantum', price:22000, type:'mult', val:2},
    {id:'ai', name:'AI Core', price:75000, type:'cps', val:1200}
  ];
  const SCALE = 1.15;

  let state = { balance:0, clicks:0, clickValue:1, cps:0, items:{}, lastSave:null };
  let lbCache = [];

  // DOM
  const balanceEl = document.getElementById('balance');
  const cpsEl = document.getElementById('cps');
  const clickValEl = document.getElementById('clickVal');
  const clickBtn = document.getElementById('clickBtn');
  const perClickEl = document.getElementById('perClick');
  const totalClicksEl = document.getElementById('totalClicks');
  const ownedItemsEl = document.getElementById('ownedItems');
  const shopListEl = document.getElementById('shopList');
  const saveStateText = document.getElementById('saveStateText');
  const playerNameEl = document.getElementById('playerName');
  const nameInput = document.getElementById('nameInput');
  const setNameBtn = document.getElementById('setNameBtn');
  const leaderboardEl = document.getElementById('leaderboard');
  const refreshBtn = document.getElementById('refreshLb');
  const submitBtn = document.getElementById('submitBtn');
  const clearBtn = document.getElementById('clearLocal');
  const flashEl = document.getElementById('flash');

  function flash(msg, t=1400){
    flashEl.textContent = msg;
    flashEl.style.display = 'block';
    setTimeout(()=> flashEl.style.display = 'none', t);
  }

  function load(){
    const raw = localStorage.getItem(STORAGE);
    if(raw) {
      try{ Object.assign(state, JSON.parse(raw)); }catch(e){}
    }
    const name = localStorage.getItem(NAME_KEY);
    if(name){ playerNameEl.textContent = name; nameInput.value = name; const locked = localStorage.getItem(LOCK_KEY); if(locked === '1'){ nameInput.disabled = true; setNameBtn.disabled = true; } }
    recalcFromItems();
  }

  function save(){
    state.lastSave = Date.now();
    localStorage.setItem(STORAGE, JSON.stringify(state));
    saveStateText.textContent = new Date(state.lastSave).toLocaleTimeString();
  }

  function format(n){
    if(!isFinite(n)) return '0';
    if(n>=1e12) return (n/1e12).toFixed(2)+'T';
    if(n>=1e9) return (n/1e9).toFixed(2)+'B';
    if(n>=1e6) return (n/1e6).toFixed(2)+'M';
    if(n>=1e3) return (n/1e3).toFixed(2)+'k';
    return Math.round(n).toString();
  }

  function itemCount(id){ return state.items[id] || 0; }
  function price(id){
    const base = shop.find(s=>s.id===id).price;
    const cnt = itemCount(id);
    return Math.max(1, Math.floor(base * Math.pow(SCALE, cnt)));
  }

  function recalcFromItems(){
    // recompute cps from items (sum of cps-type items)
    let cpsSum = 0;
    shop.forEach(s=>{
      if(s.type === 'cps') cpsSum += (itemCount(s.id) * s.val);
    });
    state.cps = +cpsSum.toFixed(6);
    // clickValue: keep stored value (we apply multipliers on purchase; stored value is authoritative)
  }

  function render(){
    balanceEl.textContent = format(state.balance);
    cpsEl.textContent = format(state.cps);
    clickValEl.textContent = +(state.clickValue.toFixed(2));
    perClickEl.textContent = +(state.clickValue.toFixed(2));
    totalClicksEl.textContent = format(state.clicks);
    ownedItemsEl.textContent = Object.values(state.items).reduce((a,b)=>a+b,0) + ' items';
    saveStateText.textContent = state.lastSave ? new Date(state.lastSave).toLocaleTimeString() : 'never';
    playerNameEl.textContent = localStorage.getItem(NAME_KEY) || 'Guest';

    shopListEl.innerHTML = '';
    shop.forEach(s=>{
      const btnDisabled = state.balance < price(s.id);
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<div class="title">${s.name} <span style="font-weight:600;color:#89a6b3;font-size:12px">x${itemCount(s.id)}</span></div>
                      <div style="font-size:12px;color:var(--muted)">${s.type === 'mult' ? 'multiplier' : s.type}</div>
                      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
                        <div class="tiny" style="color:var(--muted)">${format(price(s.id))} NC</div>
                        <button ${btnDisabled ? 'disabled':''} data-id="${s.id}">Buy</button>
                      </div>`;
      const btn = el.querySelector('button');
      btn.addEventListener('click', ()=> buy(s.id));
      shopListEl.appendChild(el);
    });
  }

  function buy(id){
    const s = shop.find(x=>x.id===id);
    const p = price(id);
    if(state.balance < p) return;
    state.balance -= p;
    state.items[id] = itemCount(id) + 1;
    if(s.type === 'click') state.clickValue = +(state.clickValue + s.val);
    else if(s.type === 'cps') state.cps = +(state.cps + s.val);
    else if(s.type === 'mult') state.clickValue = +(state.clickValue * s.val);
    recalcFromItems();
    save();
    render();
    flash('Bought ' + s.name);
  }

  clickBtn.addEventListener('click', ()=>{
    state.balance += state.clickValue;
    state.clicks += 1;
    save();
    render();
  });

  setNameBtn.addEventListener('click', ()=>{
    const v = nameInput.value.trim();
    if(!v){ flash('enter name'); return; }
    if(localStorage.getItem(LOCK_KEY) === '1'){ flash('name locked'); return; }
    localStorage.setItem(NAME_KEY, v);
    localStorage.setItem(LOCK_KEY, '1');
    nameInput.disabled = true;
    setNameBtn.disabled = true;
    playerNameEl.textContent = v;
    flash('name set');
  });

  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Clear local save?')) return;
    localStorage.removeItem(STORAGE);
    localStorage.removeItem(NAME_KEY);
    localStorage.removeItem(LOCK_KEY);
    localStorage.removeItem(LAST_SUB_KEY);
    state = { balance:0, clicks:0, clickValue:1, cps:0, items:{}, lastSave:null };
    nameInput.disabled = false;
    setNameBtn.disabled = false;
    nameInput.value = '';
    save();
    render();
    flash('cleared');
  });

  // Leaderboard
  async function fetchLB(){
    try{
      const res = await fetch(API);
      if(!res.ok) throw new Error('err');
      const data = await res.json();
      data.sort((a,b)=>Number(b.score)-Number(a.score));
      lbCache = data;
      renderLB(data.slice(0,20));
      return data;
    }catch(e){
      leaderboardEl.innerHTML = '<div class="tiny">unable to load</div>';
      return [];
    }
  }

  function renderLB(list){
    leaderboardEl.innerHTML = '';
    if(!list.length){ leaderboardEl.innerHTML = '<div class="tiny">no entries</div>'; return; }
    list.forEach((r, i)=>{
      const d = document.createElement('div');
      d.className = 'lb-row';
      d.innerHTML = `<div style="font-weight:700">${i+1}. ${escape(r.name)}</div><div class="tiny">${format(Number(r.score)||0)}</div>`;
      leaderboardEl.appendChild(d);
    });
  }

  // Update existing entry only (do not create new)
  async function tryUpdateScoreIfExists(){
    const name = localStorage.getItem(NAME_KEY) || nameInput.value.trim();
    if(!name) return;
    const list = lbCache.length ? lbCache : (await fetchLB());
    const existing = list.find(e => e.name === name);
    if(!existing) return;
    const currentScore = Math.floor(state.balance);
    if(currentScore <= Number(existing.score)) return;
    try{
      const res = await fetch(API + '/' + existing.id, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name, score: currentScore, date: new Date().toISOString() })
      });
      if(!res.ok) throw new Error('put fail');
      localStorage.setItem(LAST_SUB_KEY, String(currentScore));
      flash('score updated');
      await fetchLB();
    }catch(e){
      // ignore
    }
  }

  submitBtn.addEventListener('click', async ()=>{
    submitBtn.disabled = true;
    await fetchLB();
    await tryUpdateScoreIfExists();
    submitBtn.disabled = false;
  });

  refreshBtn.addEventListener('click', fetchLB);

  // Auto loop: refresh LB and update existing entry if improved — every REFRESH_MS (5s)
  async function autoLoop(){
    await fetchLB();
    await tryUpdateScoreIfExists();
  }

  // init
  load();
  render();
  fetchLB();
  save();
  setInterval(autoLoop, REFRESH_MS);

  // CPS tick
  setInterval(()=>{
    if(state.cps > 0){
      state.balance += state.cps;
      save();
      render();
    }
  }, 1000);

  // periodic save
  setInterval(save, 5000);
  window.addEventListener('beforeunload', save);

  function escape(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
})();
</script>
</body>
</html>
